AWSTemplateFormatVersion: '2010-09-09'

Resources:
  RoleStepFunction:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "RoleForStepFunctionSandboxAccount"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - 
          Effect: Allow
          Principal:
            Service:
              - states.amazonaws.com
          Action:
              - sts:AssumeRole
      Path: /
      Policies:
      -
        PolicyName: PolicyforStepFunction
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            -
              Effect: Allow
              Action:
                - sns:*
                - iam:*
                - logs:*
                - lambda:*
                - ssm:*
              Resource: '*'
  RoleCWE:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "RoleCWE"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - 
          Effect: Allow
          Principal:
            Service:
              - events.amazonaws.com
          Action:
              - sts:AssumeRole
      Path: /
      Policies:
      -
        PolicyName: PolicyforStepFunction
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            -
              Effect: Allow
              Action:
                - states:*
                - logs:*
              Resource: '*'

#StepFunction for monitoring days to end the account
  StepFunctionMonitoring:
    Type: "AWS::StepFunctions::StateMachine"
    DependsOn:
      - RoleStepFunction
    Properties:
      StateMachineName: "StepFunctionMonitoring"
      DefinitionString: !Sub |-
            {
              "Comment": "A Hello World example of the Amazon States Language using Pass states",
              "StartAt": "Hello",
              "States": {
                "Hello": {
                  "Type": "Pass",
                  "Result": "Hello",
                  "Next": "World"
                },
                "World": {
                  "Type": "Pass",
                  "Result": "World",
                  "End": true
                }
              }
            }
      RoleArn: !GetAtt [ RoleStepFunction, Arn ]

  CloudWatchEvent:
    Type: "AWS::Events::Rule"
    DependsOn:
      - StepFunctionMonitoring
      - RoleCWE
    Properties:
      Description: "Scheduled trigger step function every day"
      Name: "Sandbox-MonitoringEventRule"
      ScheduleExpression: "rate(1 day)"
      State: "ENABLED"
      Targets: 
        - 
          Arn: !Ref StepFunctionMonitoring
          Id: "StepFunctionMonitoring"
          RoleArn: !GetAtt RoleCWE.Arn

Outputs:
  CWE:
    Description: "Portfolio for the deploy Sandbox Account"
    Value: !Ref CloudWatchEvent